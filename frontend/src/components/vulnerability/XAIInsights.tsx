import type { RiskScore, XAIFeature, XAIExplanation } from '../../api/types'

interface XAIInsightsProps {
  vuln: RiskScore
}

export default function XAIInsights({ vuln }: XAIInsightsProps) {
  const explanations = [vuln.shap_explanation, vuln.lime_explanation].filter(
    (exp): exp is XAIExplanation => !!exp
  )

  if (explanations.length === 0) {
    return (
      <div className="gf-tab-content">
        <div className="gf-xai-empty">
          <span className="gf-xai-empty-icon">&#129504;</span>
          <div className="gf-xai-empty-title">XAI Explanations Unavailable</div>
          <div className="gf-xai-empty-desc">
            Run a full scan with ML analysis to generate SHAP and LIME explanations for this vulnerability.
          </div>
        </div>
      </div>
    )
  }

  const allFeatures = explanations.flatMap(e => e.features)
  const incCount = allFeatures.filter(f => f.direction === 'increases').length
  const decCount = allFeatures.filter(f => f.direction === 'decreases').length

  return (
    <div className="gf-tab-content">
      {/* Intro banner */}
      <div className="gf-xai-banner">
        <div className="gf-xai-banner-left">
          <span className="gf-xai-banner-icon">&#129504;</span>
          <div>
            <div className="gf-xai-banner-title">Explainable AI Analysis</div>
            <div className="gf-xai-banner-desc">
              Two independent methods explain what features drove this risk prediction.
            </div>
          </div>
        </div>
        <div className="gf-xai-banner-stats">
          <div className="gf-xai-banner-stat">
            <span className="gf-xai-banner-stat-val gf-xai-up">{incCount}</span>
            <span className="gf-xai-banner-stat-label">Risk Factors</span>
          </div>
          <div className="gf-xai-banner-stat">
            <span className="gf-xai-banner-stat-val gf-xai-down">{decCount}</span>
            <span className="gf-xai-banner-stat-label">Mitigating</span>
          </div>
          <div className="gf-xai-banner-stat">
            <span className="gf-xai-banner-stat-val">{explanations.length}</span>
            <span className="gf-xai-banner-stat-label">Methods</span>
          </div>
        </div>
      </div>

      {explanations.map((exp, blockIdx) => {
        const isShap = blockIdx === 0 && !!vuln.shap_explanation
        return (
          <div key={blockIdx} className="gf-xai-block">
            <div className="gf-xai-block-header">
              <span className={`gf-xai-badge ${isShap ? 'shap' : 'lime'}`}>
                {isShap ? 'SHAP' : 'LIME'}
              </span>
              <span className="gf-xai-method">{exp.method}</span>
              {exp.model_fit !== undefined && (
                <span className="gf-xai-fit">
                  R&sup2; = {exp.model_fit.toFixed(2)}
                </span>
              )}
            </div>

            {exp.summary && (
              <div className="gf-xai-summary">{exp.summary}</div>
            )}

            <div className="gf-xai-features">
              {exp.features.map((f: XAIFeature, i: number) => {
                const maxPct = Math.max(
                  ...exp.features.map((x: XAIFeature) => x.contribution_pct)
                )
                const barWidth = maxPct > 0 ? (f.contribution_pct / maxPct) * 100 : 0
                const isIncrease = f.direction === 'increases'

                return (
                  <div key={i} className={`gf-xai-row ${isIncrease ? 'risk-up' : 'risk-down'}`}>
                    <div className="gf-xai-name-col">
                      <span className={`gf-xai-dir-dot ${isIncrease ? 'up' : 'down'}`} />
                      <span className="gf-xai-name" title={f.description}>
                        {f.feature}
                      </span>
                    </div>
                    <div className="gf-xai-bar-wrap">
                      <div className="gf-xai-bar-center-line" />
                      <div className="gf-xai-bar-track">
                        {isIncrease ? (
                          <>
                            <div className="gf-xai-bar-left-half" />
                            <div className="gf-xai-bar-right-half">
                              <div
                                className="gf-xai-bar-fill gf-xai-bar-positive"
                                style={{ width: `${barWidth}%` }}
                              />
                            </div>
                          </>
                        ) : (
                          <>
                            <div className="gf-xai-bar-left-half">
                              <div
                                className="gf-xai-bar-fill gf-xai-bar-negative"
                                style={{ width: `${barWidth}%` }}
                              />
                            </div>
                            <div className="gf-xai-bar-right-half" />
                          </>
                        )}
                      </div>
                    </div>
                    <span className={`gf-xai-value ${isIncrease ? 'positive' : 'negative'}`}>
                      {isIncrease ? '+' : '\u2212'}{f.contribution_pct}%
                    </span>
                  </div>
                )
              })}
            </div>

            {/* Feature descriptions */}
            <div className="gf-xai-desc-list">
              {exp.features.slice(0, 3).map((f: XAIFeature, i: number) => (
                f.description && (
                  <div key={i} className="gf-xai-desc-item">
                    <span className={`gf-xai-desc-arrow ${f.direction === 'increases' ? 'up' : 'down'}`}>
                      {f.direction === 'increases' ? '\u2191' : '\u2193'}
                    </span>
                    <span className="gf-xai-desc-text">
                      <strong>{f.feature}:</strong> {f.description}
                    </span>
                  </div>
                )
              ))}
            </div>

            <div className="gf-xai-legend">
              <span className="gf-xai-legend-item">
                <span className="gf-xai-legend-swatch gf-xai-bar-positive" />
                Increases risk
              </span>
              <span className="gf-xai-legend-item">
                <span className="gf-xai-legend-swatch gf-xai-bar-negative" />
                Decreases risk
              </span>
            </div>
          </div>
        )
      })}
    </div>
  )
}

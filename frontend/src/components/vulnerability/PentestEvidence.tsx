import { useState } from 'react'
import type { RiskScore, HttpExchange as HttpExchangeType } from '../../api/types'

interface PentestEvidenceProps {
  vuln: RiskScore
}

const statusColors: Record<string, string> = {
  confirmed: 'var(--critical)',
  likely: 'var(--high)',
  unverified: 'var(--medium)',
  false_positive: 'var(--low)',
  not_tested: 'var(--text-muted)'
}

export default function PentestEvidence({ vuln }: PentestEvidenceProps) {
  const pentest = vuln.pentest
  const [expandedExchange, setExpandedExchange] = useState<number | null>(null)
  const [copiedPoc, setCopiedPoc] = useState(false)

  if (!pentest || !pentest.evidence) {
    return (
      <div className="gf-tab-content">
        <div className="gf-ev-empty">
          <span className="gf-ev-empty-icon">&#128269;</span>
          <div className="gf-ev-empty-title">
            {pentest ? 'Exploitation Not Confirmed' : 'No Pentest Data'}
          </div>
          <div className="gf-ev-empty-desc">
            {pentest
              ? `Validation completed in ${pentest.duration_seconds}s with ${pentest.attempts} attempt(s). Status: ${pentest.verification_status}.`
              : 'Pentest validation was not run for this vulnerability.'
            }
          </div>
        </div>
      </div>
    )
  }

  const evidence = pentest.evidence
  const color = statusColors[pentest.verification_status] || 'var(--text-muted)'

  const handleCopyPoc = () => {
    navigator.clipboard.writeText(evidence.poc_command)
    setCopiedPoc(true)
    setTimeout(() => setCopiedPoc(false), 2000)
  }

  return (
    <div className="gf-tab-content">
      {/* Status banner */}
      <div className="gf-ev-status" style={{ borderLeftColor: color }}>
        <div className="gf-ev-status-header">
          <span className="gf-ev-status-badge" style={{ color }}>
            {pentest.verification_status.toUpperCase()}
          </span>
          <span className="gf-ev-status-meta">
            {pentest.attempts} attempt(s) &middot; {pentest.duration_seconds}s &middot; Technique: {evidence.technique.replace(/_/g, ' ')}
          </span>
        </div>
        {evidence.impact_description && (
          <div className="gf-ev-impact">{evidence.impact_description}</div>
        )}
      </div>

      {/* Extracted Data */}
      {evidence.extracted_data.length > 0 && (
        <div className="gf-ev-card">
          <div className="gf-ev-card-header">
            <span className="gf-ev-card-icon">&#128274;</span>
            <span className="gf-ev-card-title">Extracted Data</span>
          </div>
          <div className="gf-ev-card-body">
            <div className="gf-ev-data-list">
              {evidence.extracted_data.map((item, i) => (
                <div key={i} className="gf-ev-data-item">
                  <code>{item}</code>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* PoC Command */}
      {evidence.poc_command && (
        <div className="gf-ev-card">
          <div className="gf-ev-card-header">
            <span className="gf-ev-card-icon">&#128187;</span>
            <span className="gf-ev-card-title">Proof of Concept</span>
            <button className="gf-ev-copy-btn" onClick={handleCopyPoc}>
              {copiedPoc ? 'Copied!' : 'Copy'}
            </button>
          </div>
          <div className="gf-ev-card-body">
            <pre className="gf-ev-poc">{evidence.poc_command}</pre>
          </div>
        </div>
      )}

      {/* Reproduction Steps */}
      {evidence.reproduction_steps.length > 0 && (
        <div className="gf-ev-card">
          <div className="gf-ev-card-header">
            <span className="gf-ev-card-icon">&#128221;</span>
            <span className="gf-ev-card-title">Reproduction Steps</span>
          </div>
          <div className="gf-ev-card-body">
            {evidence.reproduction_steps.map((step, i) => (
              <div key={i} className="gf-ev-step">
                <span className="gf-ev-step-num" style={{ background: color }}>{i + 1}</span>
                <span className="gf-ev-step-text">{step}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* HTTP Exchanges */}
      {evidence.http_exchanges.length > 0 && (
        <div className="gf-ev-card">
          <div className="gf-ev-card-header">
            <span className="gf-ev-card-icon">&#128259;</span>
            <span className="gf-ev-card-title">
              HTTP Exchanges ({evidence.http_exchanges.length})
            </span>
          </div>
          <div className="gf-ev-card-body">
            {evidence.http_exchanges.map((ex: HttpExchangeType, i: number) => (
              <div key={i} className="gf-ev-exchange">
                <div
                  className="gf-ev-exchange-header"
                  onClick={() => setExpandedExchange(expandedExchange === i ? null : i)}
                >
                  <span className="gf-ev-exchange-method">{ex.method}</span>
                  <span className="gf-ev-exchange-status"
                    style={{ color: ex.status_code < 400 ? 'var(--low)' : 'var(--critical)' }}
                  >
                    {ex.status_code}
                  </span>
                  <span className="gf-ev-exchange-url">{ex.url}</span>
                  <span className="gf-ev-exchange-time">{ex.response_time_ms}ms</span>
                  <span className={`gf-vuln-chevron ${expandedExchange === i ? 'open' : ''}`}>
                    &#9660;
                  </span>
                </div>
                {expandedExchange === i && (
                  <div className="gf-ev-exchange-detail">
                    <div className="gf-ev-exchange-section">
                      <div className="gf-ev-exchange-section-title">Request Headers</div>
                      <pre className="gf-ev-exchange-pre">
                        {Object.entries(ex.headers).map(([k, v]) => `${k}: ${v}`).join('\n')}
                      </pre>
                    </div>
                    {ex.body && (
                      <div className="gf-ev-exchange-section">
                        <div className="gf-ev-exchange-section-title">Request Body</div>
                        <pre className="gf-ev-exchange-pre">{ex.body}</pre>
                      </div>
                    )}
                    <div className="gf-ev-exchange-section">
                      <div className="gf-ev-exchange-section-title">Response Body (truncated)</div>
                      <pre className="gf-ev-exchange-pre gf-ev-exchange-body">
                        {ex.response_body}
                      </pre>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

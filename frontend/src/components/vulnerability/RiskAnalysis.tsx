import type { RiskScore } from '../../api/types'
import { getLevelColor } from '../ui/Badge'

interface RiskAnalysisProps {
  vuln: RiskScore
}

export default function RiskAnalysis({ vuln }: RiskAnalysisProps) {
  const color = getLevelColor(vuln.risk_level)
  const pct = Math.min(100, Math.max(0, vuln.risk_score))

  // Arc gauge calculations (half-circle)
  const radius = 54
  const strokeWidth = 8
  const circumference = Math.PI * radius
  const offset = circumference - (pct / 100) * circumference

  return (
    <div className="gf-tab-content">
      {/* Score Gauge + Summary Cards Row */}
      <div className="gf-risk-top">
        <div className="gf-risk-gauge">
          <svg viewBox="0 0 120 70" className="gf-risk-gauge-svg">
            <path
              d="M 6 64 A 54 54 0 0 1 114 64"
              fill="none"
              stroke="var(--bg-elevated)"
              strokeWidth={strokeWidth}
              strokeLinecap="round"
            />
            <path
              d="M 6 64 A 54 54 0 0 1 114 64"
              fill="none"
              stroke={color}
              strokeWidth={strokeWidth}
              strokeLinecap="round"
              strokeDasharray={circumference}
              strokeDashoffset={offset}
              style={{ transition: 'stroke-dashoffset 0.6s ease' }}
            />
          </svg>
          <div className="gf-risk-gauge-value" style={{ color }}>
            {vuln.risk_score}
          </div>
          <div className="gf-risk-gauge-label">Risk Score</div>
        </div>

        <div className="gf-risk-summary-cards">
          <div className="gf-risk-metric-card" style={{ borderTopColor: color }}>
            <div className="gf-risk-metric-value" style={{ color }}>
              {vuln.risk_level}
            </div>
            <div className="gf-risk-metric-label">Risk Level</div>
          </div>
          <div className="gf-risk-metric-card" style={{ borderTopColor: 'var(--accent)' }}>
            <div className="gf-risk-metric-value">{vuln.remediation_priority}</div>
            <div className="gf-risk-metric-label">Priority</div>
          </div>
          <div className="gf-risk-metric-card" style={{ borderTopColor: vuln.model_agreement ? 'var(--low)' : 'var(--high)' }}>
            <div className="gf-risk-metric-value" style={{ color: vuln.model_agreement ? 'var(--low)' : 'var(--high)' }}>
              {vuln.model_agreement ? 'Yes' : 'No'}
            </div>
            <div className="gf-risk-metric-label">Models Agree</div>
          </div>
          <div className="gf-risk-metric-card" style={{ borderTopColor: 'var(--accent)' }}>
            <div className="gf-risk-metric-value">{(vuln.confidence * 100).toFixed(0)}%</div>
            <div className="gf-risk-metric-label">Confidence</div>
          </div>
        </div>
      </div>

      {/* Exploit Warning */}
      {vuln.has_exploit && (
        <div className="gf-risk-exploit-warning">
          <span className="gf-risk-exploit-icon">&#9888;</span>
          <div>
            <div className="gf-risk-exploit-title">Public Exploit Available</div>
            <div className="gf-risk-exploit-desc">
              A known exploit exists for this vulnerability, significantly increasing the risk of active exploitation.
            </div>
          </div>
        </div>
      )}

      {/* CVSS Metric Bars */}
      <div className="gf-risk-cvss-row">
        <div className="gf-risk-cvss-item">
          <div className="gf-risk-cvss-bar-track">
            <div className="gf-risk-cvss-bar-fill" style={{ width: `${(vuln.cvss_base / 10) * 100}%`, background: color }} />
          </div>
          <div className="gf-risk-cvss-meta">
            <span className="gf-risk-cvss-name">CVSS Base</span>
            <span className="gf-risk-cvss-val">{vuln.cvss_base.toFixed(1)}/10</span>
          </div>
        </div>
        <div className="gf-risk-cvss-item">
          <div className="gf-risk-cvss-bar-track">
            <div className="gf-risk-cvss-bar-fill" style={{ width: `${(vuln.cvss_exploitability / 10) * 100}%`, background: 'var(--high)' }} />
          </div>
          <div className="gf-risk-cvss-meta">
            <span className="gf-risk-cvss-name">Exploitability</span>
            <span className="gf-risk-cvss-val">{vuln.cvss_exploitability.toFixed(1)}/10</span>
          </div>
        </div>
        <div className="gf-risk-cvss-item">
          <div className="gf-risk-cvss-bar-track">
            <div className="gf-risk-cvss-bar-fill" style={{ width: `${(vuln.cvss_impact / 10) * 100}%`, background: 'var(--medium)' }} />
          </div>
          <div className="gf-risk-cvss-meta">
            <span className="gf-risk-cvss-name">Impact</span>
            <span className="gf-risk-cvss-val">{vuln.cvss_impact.toFixed(1)}/10</span>
          </div>
        </div>
      </div>

      {/* Key Risk Factors */}
      {vuln.primary_factors && vuln.primary_factors.length > 0 && (
        <div className="gf-risk-factors-section">
          <div className="gf-section-title">Key Risk Factors</div>
          <div className="gf-risk-factor-cards">
            {vuln.primary_factors.map((factor, i) => (
              <div key={i} className="gf-risk-factor-card">
                <span className="gf-risk-factor-num">{i + 1}</span>
                <span className="gf-risk-factor-text">{factor}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ML Explanation */}
      {vuln.explanation && (
        <div className="gf-risk-explain">
          <div className="gf-risk-explain-header">
            <span className="gf-risk-explain-icon">&#129302;</span>
            <span className="gf-risk-explain-label">ML Analysis</span>
          </div>
          <div className="gf-risk-explain-text">{vuln.explanation}</div>
        </div>
      )}
    </div>
  )
}

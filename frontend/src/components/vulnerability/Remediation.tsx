import type { RiskScore } from '../../api/types'
import { getLevelColor } from '../ui/Badge'

interface RemediationProps {
  vuln: RiskScore
}

const CWE_REFERENCES: Record<string, { name: string; link: string }> = {
  'CWE-89':  { name: 'SQL Injection', link: 'https://cwe.mitre.org/data/definitions/89.html' },
  'CWE-79':  { name: 'Cross-site Scripting (XSS)', link: 'https://cwe.mitre.org/data/definitions/79.html' },
  'CWE-352': { name: 'Cross-Site Request Forgery', link: 'https://cwe.mitre.org/data/definitions/352.html' },
}

export default function Remediation({ vuln }: RemediationProps) {
  const color = getLevelColor(vuln.risk_level)
  const cweId = vuln.what?.cwe_id || ''
  const cweRef = CWE_REFERENCES[cweId]

  if (!vuln.how_to_fix) {
    return (
      <div className="gf-tab-content">
        <div className="gf-remed-empty">
          <span className="gf-remed-empty-icon">&#128221;</span>
          <div className="gf-remed-empty-text">
            No specific remediation guidance is available for this vulnerability.
          </div>
        </div>
      </div>
    )
  }

  const rawLines = vuln.how_to_fix.remediation
    .split('\n')
    .map(line => line.trim())
    .filter(line => line.length > 0)

  // Separate first line (context) from numbered steps
  const contextLine = rawLines.find(l => !l.match(/^\d+\./))
  const steps = rawLines.filter(l => l.match(/^\d+\./)).map(l => l.replace(/^\d+\.\s*/, ''))
  // If no numbered steps found, treat all lines as steps
  const finalSteps = steps.length > 0 ? steps : rawLines.filter(l => l !== contextLine)

  return (
    <div className="gf-tab-content">
      {/* Severity context banner */}
      <div className="gf-remed-banner" style={{ borderLeftColor: color }}>
        <div className="gf-remed-banner-level" style={{ color }}>
          {vuln.risk_level} Severity
        </div>
        <div className="gf-remed-banner-priority">
          Priority: <strong>{vuln.remediation_priority || vuln.how_to_fix.priority || 'Review'}</strong>
        </div>
      </div>

      {/* Context */}
      {contextLine && (
        <div className="gf-remed-context">{contextLine}</div>
      )}

      {/* Steps */}
      <div className="gf-remed-steps">
        <div className="gf-remed-steps-title">Remediation Steps</div>
        {finalSteps.map((step, i) => (
          <div key={i} className="gf-remed-step">
            <div className="gf-remed-step-num" style={{ background: color }}>
              {i + 1}
            </div>
            <div className="gf-remed-step-text">{step}</div>
          </div>
        ))}
      </div>

      {/* References */}
      {cweRef && (
        <div className="gf-remed-refs">
          <div className="gf-remed-refs-title">References</div>
          <div className="gf-remed-ref-card">
            <span className="gf-remed-ref-badge">{cweId}</span>
            <span className="gf-remed-ref-name">{cweRef.name}</span>
            <span className="gf-remed-ref-link">MITRE CWE Database</span>
          </div>
          <div className="gf-remed-ref-card">
            <span className="gf-remed-ref-badge">OWASP</span>
            <span className="gf-remed-ref-name">Prevention Cheat Sheet</span>
            <span className="gf-remed-ref-link">OWASP Cheat Sheet Series</span>
          </div>
        </div>
      )}
    </div>
  )
}

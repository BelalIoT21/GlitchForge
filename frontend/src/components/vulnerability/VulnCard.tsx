import { useState } from 'react'
import type { RiskScore } from '../../api/types'
import Badge, { getLevelColor } from '../ui/Badge'
import Tabs from '../ui/Tabs'
import VulnOverview from './VulnOverview'
import RiskAnalysis from './RiskAnalysis'
import XAIInsights from './XAIInsights'
import Remediation from './Remediation'
import PentestEvidence from './PentestEvidence'

interface VulnCardProps {
  vuln: RiskScore
}

const TABS = ['Overview', 'Evidence', 'Risk Analysis', 'XAI Insights', 'Remediation']

const verifiedLabels: Record<string, string> = {
  confirmed: 'VERIFIED',
  likely: 'LIKELY',
  unverified: 'UNVERIFIED',
  false_positive: 'FALSE POS.',
  not_tested: ''
}

export default function VulnCard({ vuln }: VulnCardProps) {
  const [expanded, setExpanded] = useState(false)
  const [activeTab, setActiveTab] = useState('Overview')

  const color = getLevelColor(vuln.risk_level)

  const handleToggle = () => {
    setExpanded(!expanded)
    if (!expanded) setActiveTab('Overview')
  }

  const verifiedLabel = vuln.verified ? verifiedLabels[vuln.verified] : ''

  return (
    <div className="gf-vuln" style={{ borderLeftColor: color }}>
      {/* Header â€” always visible */}
      <div className="gf-vuln-header" onClick={handleToggle}>
        <div className="gf-vuln-header-left">
          <Badge level={vuln.risk_level} />
          {verifiedLabel && (
            <span className={`gf-vuln-verified gf-vuln-verified--${vuln.verified}`}>
              {verifiedLabel}
            </span>
          )}
          {vuln.what && (
            <span className="gf-vuln-type">{vuln.what.vulnerability_type}</span>
          )}
        </div>
        <div className="gf-vuln-header-right">
          <span className="gf-vuln-score" style={{ color }}>
            {vuln.risk_score}
            <span className="gf-vuln-score-max">/100</span>
          </span>
          <span className={`gf-vuln-chevron ${expanded ? 'open' : ''}`}>&#9660;</span>
        </div>
      </div>

      {/* Collapsed summary */}
      {!expanded && vuln.where && (
        <div className="gf-vuln-summary">
          <span className="gf-vuln-summary-url">{vuln.where.url}</span>
          <span className="gf-vuln-summary-param">param: {vuln.where.parameter}</span>
        </div>
      )}

      {/* Expanded detail */}
      {expanded && (
        <div className="gf-vuln-detail">
          <Tabs tabs={TABS} activeTab={activeTab} onTabChange={setActiveTab} />

          {activeTab === 'Overview' && <VulnOverview vuln={vuln} />}
          {activeTab === 'Evidence' && <PentestEvidence vuln={vuln} />}
          {activeTab === 'Risk Analysis' && <RiskAnalysis vuln={vuln} />}
          {activeTab === 'XAI Insights' && <XAIInsights vuln={vuln} />}
          {activeTab === 'Remediation' && <Remediation vuln={vuln} />}
        </div>
      )}
    </div>
  )
}

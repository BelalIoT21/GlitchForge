"""
GlitchForge Pentester - Data Models
Structured evidence and verification results for exploitation validation
"""

from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
from typing import Dict, List, Optional


class VerificationStatus(Enum):
    """Outcome of exploitation attempt"""
    CONFIRMED = "confirmed"
    LIKELY = "likely"
    UNVERIFIED = "unverified"
    FALSE_POSITIVE = "false_positive"


class ExploitTechnique(Enum):
    """Exploitation technique used"""
    # SQL Injection
    SQLI_UNION = "union_based_extraction"
    SQLI_BOOLEAN_BLIND = "boolean_blind"
    SQLI_TIME_BLIND = "time_based_blind"
    SQLI_ERROR_BASED = "error_based_extraction"
    # XSS
    XSS_REFLECTED = "reflected_script_execution"
    XSS_CONTEXT_ESCAPE = "context_aware_escape"
    XSS_CSP_BYPASS = "csp_analysis"
    # CSRF
    CSRF_NO_ORIGIN = "cross_origin_no_referer"
    CSRF_TOKEN_OMIT = "token_omission"


@dataclass
class HttpExchange:
    """Captured HTTP request/response pair"""
    method: str
    url: str
    headers: Dict[str, str]
    body: Optional[str]
    status_code: int
    response_headers: Dict[str, str]
    response_body: str
    response_time_ms: float

    def to_dict(self) -> Dict:
        return {
            'method': self.method,
            'url': self.url,
            'headers': {k: v for k, v in self.headers.items()
                        if k.lower() not in ('cookie',)},
            'body': self.body,
            'status_code': self.status_code,
            'response_headers': dict(self.response_headers),
            'response_body': self.response_body[:2000],
            'response_time_ms': round(self.response_time_ms, 1)
        }


@dataclass
class PentestEvidence:
    """Structured evidence from exploitation attempt"""
    technique: ExploitTechnique
    http_exchanges: List[HttpExchange] = field(default_factory=list)
    poc_command: str = ""
    extracted_data: List[str] = field(default_factory=list)
    impact_description: str = ""
    reproduction_steps: List[str] = field(default_factory=list)

    def to_dict(self) -> Dict:
        return {
            'technique': self.technique.value,
            'http_exchanges': [ex.to_dict() for ex in self.http_exchanges],
            'poc_command': self.poc_command,
            'extracted_data': self.extracted_data,
            'impact_description': self.impact_description,
            'reproduction_steps': self.reproduction_steps,
        }


@dataclass
class PentestResult:
    """Result of attempting to exploit a vulnerability"""
    vulnerability_url: str
    vulnerability_parameter: str
    vulnerability_type: str
    verification_status: VerificationStatus
    confidence: float
    evidence: Optional[PentestEvidence] = None
    attempts: int = 0
    duration_seconds: float = 0.0
    timestamp: datetime = field(default_factory=datetime.now)
    error_message: str = ""

    def to_dict(self) -> Dict:
        return {
            'vulnerability_url': self.vulnerability_url,
            'vulnerability_parameter': self.vulnerability_parameter,
            'vulnerability_type': self.vulnerability_type,
            'verification_status': self.verification_status.value,
            'confidence': round(self.confidence, 2),
            'evidence': self.evidence.to_dict() if self.evidence else None,
            'attempts': self.attempts,
            'duration_seconds': round(self.duration_seconds, 2),
            'timestamp': self.timestamp.isoformat(),
            'error_message': self.error_message
        }
